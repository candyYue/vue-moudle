(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{"2YVN":function(t,e,i){},CoYH:function(t,e,i){"use strict";var a=i("G1D9");i.n(a).a},G1D9:function(t,e,i){},WQji:function(t,e,i){"use strict";var a={name:"toop-tip",props:{content:String},data:function(){return{show:!1}},methods:{toggleTip:function(t){this.show=t}}},s=(i("CoYH"),i("KHd+")),r=Object(s.a)(a,function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"tool-tip"},[e("span",{staticClass:"tool-tip-icon"}),e("div",{staticClass:"tool-tip-content"},[this._t("default",[this._v("\n        "+this._s(this.content)+"\n      ")])],2)])},[],!1,null,null,null);e.a=r.exports},lWPl:function(t,e,i){"use strict";i.r(e);i("f3/d"),i("ls82");var a,s,r=i("MECJ"),n=(i("rGqo"),i("yT7P")),l=i("WQji"),o=i("L2JU"),c=i("doUU"),u=i("gXkj"),p=i("QIt3"),m=i("9y2E"),d=i("oI6n"),f={data:function(){var t=this;return{api:p.a,pickerBeginDateBefore:{disabledDate:function(e){var i=t.formInline.time.endTime;return i?e.getTime()>i:e.getTime()>Date.now()}},pickerBeginDateAfter:{disabledDate:function(e){var i=t.formInline.time.beginTime;return i&&e.getTime()<i||e.getTime()>Date.now()}},taskTitle:"创建任务",taskloading:!1,formInline:{title:this.$route.query.title||"",script_id:+this.$route.query.script_id||"",time:{beginTime:1e3*this.$route.query.start_time||"",endTime:1e3*this.$route.query.end_time||""}},taskCategory:[{value:"",label:"全部"},{value:0,label:"未开始"},{value:7,label:"待开始"},{value:1,label:"进行中"},{value:3,label:"已暂停"},{value:2,label:"已完成"}],taskModal:!1,ruleForm:{title:"",script_id:"",customer_file:null,ai_count:""},rules:{title:[{required:!0,message:"请输入任务名称"},d.a],script_id:[{validator:function(e,i,a){t.scriptList.length?(i||a(new Error("请选择话术模板")),a()):a(new Error("请先在话术管理模块创建一个话术"))},trigger:"change"}],customer_file:[{required:!0,message:"请导入客户表格"}],ai_count:[{validator:function(e,i,a){t.EpInfo.account_num?(i||a(new Error("请选择机器人数量")),a()):a(new Error("当前无机器人"))},trigger:"change"}]},importModal:!1,time:null,progressstatus:null,importhash:null,percentage:0,progresstotal:0,progresssuccess:0,progresserror:0,ai_countOptions:[],currentstatus:void 0===this.$route.query.status?"":+this.$route.query.status,currentpage:+this.$route.query.page||1,pageKey:"task",filename:"",fileerror:"",multipleSelection:[]}},components:{Modal:c.a,Tooltip:l.a},computed:Object(n.a)({},Object(o.c)({taskList:"AICall/taskList",taskListTotal:"AICall/taskListTotal",scriptList:"AICall/scriptList",free:"AICall/free",EpInfo:"AICall/EpInfo",limitMap:"limitMap"}),{currentlimit:function(){return this.limitMap[this.pageKey]||10},opts:function(){var t={limit:this.currentlimit,page:this.currentpage,status:this.currentstatus,title:this.formInline.title,script_id:this.formInline.script_id,start_time:this.formInline.time.beginTime,end_time:this.formInline.time.endTime};for(var e in t)""!==t[e]&&void 0!==t[e]&&null!==t[e]||delete t[e];return t}}),watch:{$route:"handlePage"},methods:Object(n.a)({},Object(o.b)({getTasks:"AICall/getTasks",getScripts:"AICall/getScripts",getfree:"AICall/getfree",saveTask:"AICall/saveTask",importAITask:"AICall/importAITask",controlTask:"AICall/controlTask",deleteTasks:"AICall/deleteTasks",taskClues:"AICall/taskClues",getEpInfo:"AICall/getEpInfo",changeLimit:"changeLimit"}),{handlePage:function(){var t=+this.$route.query.page||1,e=+this.$route.query.limit||this.currentlimit,i=""===this.$route.query.status||void 0===this.$route.query.status?"":+this.$route.query.status,a=this.$route.query.title||"",s=+this.$route.query.script_id||"",r=+this.$route.query.start_time||"",n=+this.$route.query.end_time||"";this.currentpage=t,this.currentstatus=i,this.formInline.title=a,this.formInline.script_id=s,this.formInline.time.beginTime=r,this.formInline.time.endTime=n,this.changeLimit({key:this.pageKey,limit:e});var l={page:t,status:i,title:a,limit:e,script_id:s,start_time:r?r/1e3:"",end_time:n?n/1e3+86400-1:""};for(var o in l)""!==l[o]&&void 0!==l[o]&&null!==l[o]||delete l[o];this.getTasks(l)},onSearch:function(){this.currentpage=1,this.$router.push({name:"AICall-task",query:this.opts})},handleCurrentChange:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.currentpage=t,this.$router.push({name:"AICall-task",query:this.opts})},handleSizeChange:function(t){this.changeLimit({key:this.pageKey,limit:t}),this.onSearch()},changecurrentstatus:function(t){this.currentstatus=t,this.onSearch()},toggleSelection:function(t){var e=this;t?t.forEach(function(t){e.$refs.multipleTable.toggleRowSelection(t)}):this.$refs.multipleTable.clearSelection()},handleSelectionChange:function(t){this.multipleSelection=t},deletetask:function(){if(0===this.multipleSelection.length)return u.b.$warning({content:"请您选择需要删除的任务。"}),!1;if(1===this.multipleSelection.length&&1===this.multipleSelection[0].status)return u.b.$warning({content:"您需要先暂停任务，再进行删除。"}),!1;if(this.multipleSelection.filter(function(t){return 1===t.status}).length)return u.b.$warning({content:"您的选择包含进行中的任务，请选择非进行中的任务再进行删除。"}),!1;var t=this.multipleSelection.map(function(t){return t.id}),e=this;u.a.$error({title:"删除提示",content:"您确定要删除该任务吗？",successCallback:function(){e.deleteTasks({id:t}).then(function(i){0===i.status&&(e.taskList.length===t.length&&e.currentpage>1?e.handleCurrentChange(e.currentpage-1):e.handlePage(),u.b.$success({content:"删除成功！"}))})}})},creatTask:(s=Object(r.a)(regeneratorRuntime.mark(function t(e,i,a){var s,r,l,o,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!(this.taskListTotal>=2e3)){t.next=3;break}return u.b.$warning({content:"您的任务数量已达上限，无法继续创建"}),t.abrupt("return",!1);case 3:return t.next=5,this.getEpInfo();case 5:if(parseInt(this.EpInfo.account_num))for(this.ai_countOptions=[],s=1;s<=parseInt(this.EpInfo.account_num);s++)this.ai_countOptions.push({value:s,label:s});this.$refs[i].clearValidate(),this.$refs[i].resetFields(),this.filename="",this.fileerror="",this.$refs.customer_file.value="",1===e?(this.taskTitle="创建任务",this.rules.customer_file=[{required:!0,message:"请导入客户表格"}]):(this.taskTitle="编辑任务",this.rules.customer_file=[{required:!1}],r=this.scriptList.filter(function(t){return t.id===a.script_id}),l=a.id,o=a.title,a.script_id,c=a.ai_count,1===r.length?this.ruleForm=Object(n.a)({},this.ruleForm,a):(this.ruleForm=Object(n.a)({},this.ruleForm,{id:l,title:o,ai_count:c}),this.$refs.ruleForm.validateField("script_id"))),this.taskModal=!0,this.taskloading=!1;case 14:case"end":return t.stop()}},t,this)})),function(t,e,i){return s.apply(this,arguments)}),cancel:function(){this.taskModal=!1},getTasksAction:function(){this.handlePage(),u.b.$success({content:"操作成功！"})},handleAction:(a=Object(r.a)(regeneratorRuntime.mark(function t(e,i){var a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a=this,"pause"===e&&u.a.$warning({title:"暂停提示",content:"您确定要暂停该任务吗？",successCallback:function(){a.controlTask({id:i.id,operate:e}).then(function(t){0===t.status&&(u.b.$success({content:"任务已暂停！"}),a.handlePage())})}}),"start"!==e){t.next=26;break}if(Object(m.a)(this.EpInfo.daily_start_time,this.EpInfo.daily_end_time)){t.next=8;break}return u.b.$warning({content:"现在是非外呼时间段，机器人无法进行外呼任务"}),t.abrupt("return",!1);case 8:return t.next=10,this.getfree();case 10:if(0!==this.free){t.next=15;break}return u.a.$warning({comfirmText:"继续执行",title:"任务提示",content:"当前没有空闲的机器人可以执行任务，如需".concat(i.ai_count,"个执行任务，请先暂停或修改其他任务。点击继续，机器人将在空闲时自动加入任务。"),successCallback:function(){a.controlTask({id:i.id,operate:e}).then(function(t){0===t.status&&a.getTasksAction()})}}),t.abrupt("return",!1);case 15:if(!(i.ai_count>this.free&&i.clue_count>this.free)){t.next=20;break}return u.a.$warning({comfirmText:"继续执行",title:"任务提示",content:"当前只有".concat(this.free,"个空闲外呼机器人可以执行任务，如需").concat(i.ai_count,"个执行任务，请先暂停或修改其他任务。点击继续，将以").concat(this.free,"个机器人执行任务，待余下的机器人空闲时自动加入任务。"),successCallback:function(){a.controlTask({id:i.id,operate:e,ai_count:a.free}).then(function(t){0===t.status&&a.getTasksAction()})}}),t.abrupt("return",!1);case 20:if(!(i.ai_count<this.free&&i.clue_count>i.ai_count)){t.next=25;break}return u.a.$warning({comfirmText:"快速呼出",cancelText:"普通呼出",title:"任务提示",content:"当前空闲机器人数为".concat(this.free,"个，可以全部执行任务，进行快速呼出，提高任务效率。"),successCallback:function(){a.controlTask({id:i.id,operate:e,ai_count:a.free}).then(function(t){0===t.status&&a.getTasksAction()})},cancelCallback:function(){a.controlTask({id:i.id,operate:e}).then(function(t){0===t.status&&a.getTasksAction()})}}),t.abrupt("return",!1);case 25:this.controlTask({id:i.id,operate:e}).then(function(t){0===t.status&&a.getTasksAction()});case 26:"edit"===e&&(1===i.status?u.b.$warning({content:"您的任务需要先暂停，再进行编辑"}):this.creatTask(2,"ruleForm",i)),"show"===e&&this.$router.push({name:"AICall-task-id",params:{id:i.id}}),"download"===e&&(window.location.href="".concat(p.a.AICall.getTaskClues,"?task_id=").concat(i.id,"&export=1"));case 29:case"end":return t.stop()}},t,this)})),function(t,e){return a.apply(this,arguments)}),savefile:function(t){if(".csv"!==t.target.files[0].name.slice(-4))return this.fileerror="请选择csv格式的文件",void(this.filename="");this.filename=t.target.files[0].name,this.ruleForm.customer_file=t.target.files[0],this.$refs.ruleForm.validateField("customer_file")},submitForm:function(t){var e=this;this.$refs[t].validate(function(t){if(!t)return!1;e.taskloading=!0;var i=new FormData;"编辑任务"===e.taskTitle&&i.append("id",e.ruleForm.id),i.append("title",e.ruleForm.title),i.append("script_id",e.ruleForm.script_id);var a=e.scriptList.filter(function(t){return t.id===e.ruleForm.script_id});i.append("script_title",a[0].title),i.append("customer_file",e.ruleForm.customer_file),i.append("ai_count",e.ruleForm.ai_count);var s=new XMLHttpRequest;s.open("POST",p.a.AICall.setTask,!0),s.send(i),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status){var t=JSON.parse(s.response);if(0===t.status)if(e.taskModal=!1,"编辑任务"!==e.taskTitle||e.ruleForm.customer_file){e.importModal=!0,e.percentage=0,e.progressstatus=null;var i=e;e.importhash=t.data.hash,e.time=setInterval(function(t){i.importAITask({hash:e.importhash}).then(function(t){e.percentage=t.data.per,0===t.status&&100===t.data.per&&(e.progressstatus="success",e.progresstotal=t.data.total,e.progresssuccess=t.data.total-t.data.error,e.progresserror=t.data.error,e.progresssuccess&&!e.progresserror&&setTimeout(function(){e.importModal=!1},2e3),clearInterval(i.time),e.currentpage=1,i.handlePage(),e.taskloading=!1)})},2e3)}else e.handlePage(),u.b.$success({content:"修改成功！"});else 103001===t.status?(e.filename="",e.fileerror=t.info,e.taskloading=!1):101018===t.status?(u.b.$warning({content:t.info}),e.taskloading=!1):(u.b.$error({content:t.info}),e.taskloading=!1)}}})},cancelimportModal:function(){this.importModal=!1,clearInterval(this.time)}}),mounted:function(){this.getScripts(),this.handlePage(),this.getEpInfo()}},h=(i("qYt/"),i("KHd+")),g=Object(h.a)(f,function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"task"},[i("div",{staticStyle:{"overflow-x":"auto"}},[i("div",{staticStyle:{width:"100%","min-width":"1400px"}},[i("div",{staticClass:"table-search"},[i("el-form",{staticClass:"demo-form-inline",attrs:{inline:!0,model:t.formInline}},[i("el-form-item",{attrs:{label:"任务名称"}},[i("el-input",{attrs:{placeholder:"请输入任务名称",maxlength:"20"},model:{value:t.formInline.title,callback:function(e){t.$set(t.formInline,"title","string"==typeof e?e.trim():e)},expression:"formInline.title"}})],1),i("el-form-item",{attrs:{label:"话术名称"}},[i("el-select",{attrs:{placeholder:"请输入话术名称",filterable:"",clearable:"","popper-class":"select-width176"},model:{value:t.formInline.script_id,callback:function(e){t.$set(t.formInline,"script_id",e)},expression:"formInline.script_id"}},t._l(t.scriptList,function(t,e){return i("el-option",{key:e,attrs:{label:t.title,value:t.id,title:t.title}})}))],1),i("el-form-item",[i("el-form-item",{staticClass:"narrow",attrs:{label:"创建时间"}},[i("el-date-picker",{attrs:{type:"date","picker-options":t.pickerBeginDateBefore,format:"yyyy-MM-dd","value-format":"timestamp",placeholder:"开始时间"},model:{value:t.formInline.time.beginTime,callback:function(e){t.$set(t.formInline.time,"beginTime",e)},expression:"formInline.time.beginTime"}})],1),i("el-form-item",{attrs:{label:"至"}},[i("el-date-picker",{attrs:{type:"date","picker-options":t.pickerBeginDateAfter,format:"yyyy-MM-dd","value-format":"timestamp",placeholder:"结束时间"},model:{value:t.formInline.time.endTime,callback:function(e){t.$set(t.formInline.time,"endTime",e)},expression:"formInline.time.endTime"}})],1)],1),i("el-form-item",[i("el-button",{attrs:{type:"primary"},on:{click:t.onSearch}},[t._v("搜索")])],1)],1)],1),i("hr",{staticClass:"horizontal-line"}),i("div",{staticClass:"overflow-hidden creat-task"},[i("el-select",{on:{change:t.changecurrentstatus},model:{value:t.currentstatus,callback:function(e){t.currentstatus=e},expression:"currentstatus"}},t._l(t.taskCategory,function(t,e){return i("el-option",{key:e,attrs:{label:t.label,value:t.value}})})),i("div",{staticClass:"float-right"},[i("el-button",{attrs:{type:"primary",icon:"el-icon-plus"},on:{click:function(e){t.creatTask(1,"ruleForm")}}},[t._v("创建任务")]),i("el-button",{staticClass:"delete-task btn-error",attrs:{icon:"el-icon-close",type:"info"},on:{click:t.deletetask}},[t._v("批量删除")])],1)],1),i("el-table",{ref:"multipleTable",attrs:{data:t.taskList},on:{"selection-change":t.handleSelectionChange}},[i("el-table-column",{attrs:{type:"selection",width:"45"}}),i("el-table-column",{attrs:{label:"序号",width:"70"},scopedSlots:t._u([{key:"default",fn:function(e){return[i("span",[t._v(t._s((t.currentpage-1)*t.currentlimit+(e.$index+1)))])]}}])}),i("el-table-column",{attrs:{label:"任务名称",prop:"title",width:"160",align:"left"}}),i("el-table-column",{attrs:{label:"话术名称",prop:"script_title",width:"160",align:"left"}}),i("el-table-column",{attrs:{prop:"clue_count",label:"客户数量","min-width":"100"}}),i("el-table-column",{attrs:{prop:"create_time",label:"创建时间","min-width":"160"},scopedSlots:t._u([{key:"default",fn:function(e){return[i("span",[t._v(t._s(t._f("formatTime")(e.row.create_time)))])]}}])}),i("el-table-column",{attrs:{prop:"start_time",label:"实际开始时间","min-width":"160"},scopedSlots:t._u([{key:"default",fn:function(e){return[i("span",[t._v(t._s(t._f("formatTime")(e.row.start_time)))])]}}])}),i("el-table-column",{attrs:{prop:"end_time",label:"结束时间","min-width":"160"},scopedSlots:t._u([{key:"default",fn:function(e){return[i("span",[t._v(t._s(t._f("formatTime")(e.row.end_time)))])]}}])}),i("el-table-column",{attrs:{label:"任务状态","min-width":"80"},scopedSlots:t._u([{key:"default",fn:function(e){return[0===e.row.status||-1===e.row.status?i("span",{staticClass:"info-text"},[t._v("未开始")]):t._e(),7===e.row.status?i("span",{staticClass:"waiting-text"},[t._v("待开始")]):t._e(),1===e.row.status?i("span",{staticClass:"primary-text"},[t._v("进行中")]):t._e(),2===e.row.status?i("span",{staticClass:"success-text"},[t._v("已完成")]):t._e(),3===e.row.status||5===e.row.status||6===e.row.status?i("span",{staticClass:"warning-text"},[t._v("已暂停")]):t._e()]}}])}),i("el-table-column",{attrs:{label:"操作","min-width":"160","class-name":"visible-cell multiple-actions"},scopedSlots:t._u([{key:"default",fn:function(e){return[i("el-button",{attrs:{type:"text",icon:"el-icon-edit",disabled:1===e.row.status||2===e.row.status||6===e.row.status||7===e.row.status},on:{click:function(i){t.handleAction("edit",e.row)}}}),i("el-button",{attrs:{type:"text",icon:"el-icon-pause",disabled:1!==e.row.status&&7!==e.row.status},on:{click:function(i){t.handleAction("pause",e.row)}}}),i("el-button",{attrs:{type:"text",icon:"el-icon-play",disabled:1===e.row.status||2===e.row.status||4===e.row.status||7===e.row.status},on:{click:function(i){t.handleAction("start",e.row)}}}),i("el-button",{attrs:{type:"text",icon:"el-icon-show",disabled:-1===e.row.status||4===e.row.status},on:{click:function(i){t.handleAction("show",e.row)}}}),i("el-button",{attrs:{type:"text",icon:"el-icon-download",disabled:-1===e.row.status||4===e.row.status},on:{click:function(i){t.handleAction("download",e.row)}}})]}}])})],1)],1)]),t.taskList&&t.taskList.length>0?i("el-pagination",{attrs:{"current-page":t.currentpage,"page-size":t.currentlimit,background:"","page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",total:t.taskListTotal},on:{"size-change":t.handleSizeChange,"current-change":t.handleCurrentChange}}):t._e(),i("Modal",{attrs:{title:t.taskTitle,loading:t.taskloading,draggable:""},on:{cancel:t.cancel,comfirm:function(e){t.submitForm("ruleForm")}},model:{value:t.taskModal,callback:function(e){t.taskModal=e},expression:"taskModal"}},[i("el-form",{ref:"ruleForm",staticClass:"demo-ruleForm",attrs:{model:t.ruleForm,rules:t.rules,"label-width":"131px"}},[i("el-form-item",{attrs:{label:"任务名称",prop:"title",required:""}},[i("el-input",{staticStyle:{width:"300px"},attrs:{maxlength:"20",placeholder:"请输入任务名称"},model:{value:t.ruleForm.title,callback:function(e){t.$set(t.ruleForm,"title","string"==typeof e?e.trim():e)},expression:"ruleForm.title"}})],1),i("el-form-item",{attrs:{label:"话术选择",prop:"script_id",required:""}},[i("el-select",{staticStyle:{width:"300px"},attrs:{placeholder:"请选择话术",filterable:"","popper-class":"select-width300"},model:{value:t.ruleForm.script_id,callback:function(e){t.$set(t.ruleForm,"script_id",e)},expression:"ruleForm.script_id"}},t._l(t.scriptList,function(t,e){return i("el-option",{key:e,attrs:{label:t.title,value:t.id,title:t.title}})}))],1),i("el-form-item",{attrs:{label:"客户导入",prop:"customer_file"}},[i("Tooltip",{attrs:{content:"请按照数据模板的要求准备要导入的数据。导入文件格式为csv"}}),i("label",{staticClass:"upload",attrs:{for:"input"}},[i("input",{ref:"customer_file",staticClass:"change",staticStyle:{display:"none"},attrs:{id:"input",type:"file",name:"customer_file",accept:".csv"},on:{change:function(e){return e.stopPropagation(),t.savefile(e)}}}),t._v("\n        选取文件\n      ")]),i("a",{staticClass:"temp-download",attrs:{href:t.api.AICall.tmpCustoms}},[i("i",{staticClass:"el-icon-downloadtemp"}),t._v("模板下载")]),t.filename?i("p",{staticClass:"file-tip info-text"},[t._v("已选择："+t._s(t.filename))]):i("p",{staticClass:"file-tip error-text"},[t._v(t._s(t.fileerror))])],1),i("el-form-item",{attrs:{label:"外呼机器人数",prop:"ai_count",required:""}},[i("el-select",{staticStyle:{width:"300px"},attrs:{placeholder:"请选择机器人数量"},model:{value:t.ruleForm.ai_count,callback:function(e){t.$set(t.ruleForm,"ai_count",e)},expression:"ruleForm.ai_count"}},t._l(t.ai_countOptions,function(t,e){return i("el-option",{key:e,attrs:{label:t.label,value:t.value}})}))],1)],1)],1),i("Modal",{attrs:{title:t.taskTitle,showFooter:!1},on:{cancel:t.cancelimportModal},model:{value:t.importModal,callback:function(e){t.importModal=e},expression:"importModal"}},[i("div",{staticClass:"importbox"},[i("el-progress",{attrs:{percentage:t.percentage,"stroke-width":10,status:t.progressstatus}}),100!==t.percentage?i("p",[t._v("正在导入客户数据...")]):t._e(),100===t.percentage?i("p",[t._v("导入完成，共"),i("span",[t._v(" "+t._s(t.progresstotal)+" ")]),t._v("条，导入成功"),i("span",{staticClass:"success-text"},[t._v(" "+t._s(t.progresssuccess)+" ")]),t._v("条，导入失败"),i("span",{staticClass:"error-text"},[t._v(" "+t._s(t.progresserror)+" ")]),t._v("条。\n      "),i("br"),t.progresserror?i("span",[i("a",{attrs:{href:t.api.AICall.getImportReport+"?hash="+t.importhash}},[t._v("下载错误报告，")]),t._v("查看失败原因。")]):t._e()]):t._e()],1)])],1)},[],!1,null,null,null);e.default=g.exports},oI6n:function(t,e,i){"use strict";i.d(e,"b",function(){return a}),i.d(e,"a",function(){return s});var a=/[<>&'"]{1,}/,s={validator:function(t,e,i){e&&a.test(e)&&i(new Error("请不要输入非法字符")),i()},trigger:["change","blur"]}},"qYt/":function(t,e,i){"use strict";var a=i("2YVN");i.n(a).a}}]);